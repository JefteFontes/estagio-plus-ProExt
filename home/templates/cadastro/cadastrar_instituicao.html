{% extends "cadastro/base.html" %}
{% load static %}

{% block content %}
<div class="container-login">
    <!-- Área do Formulário -->
    <div class="login-form">
        <img src="{% static 'img/logo.png' %}" alt="Logo +Estagio" class="logo">

        <div class='text-login'>
            <h1>Cadastro de Instituição</h1>
            <p>Preencha os dados da sua instituição de ensino</p>
        </div>

        <!-- Barra de Progresso -->
        <div class="progress-steps">
            <div class="step active" id="step-indicator-1">
                <div class="step-number">1</div>
                <div class="step-label">Instituição</div>
            </div>
            <div class="step" id="step-indicator-2">
                <div class="step-number">2</div>
                <div class="step-label">Endereço</div>
            </div>
            <div class="step" id="step-indicator-3">
                <div class="step-number">3</div>
                <div class="step-label">Coordenador</div>
            </div>
        </div>

        <!-- Mensagem de erro principal -->
        <div id="error-alert" class="alert alert-danger d-none" role="alert">
            <span id="error-text"></span>
            <button type="button" class="close-alert" aria-label="Fechar">
                &times;
            </button>
        </div>

        <form method="post" id="cadastroForm" novalidate>
            {% csrf_token %}
            {{ redirect_field }}

            <!-- Etapa 1 - Dados da Instituição -->
            <div class="form-step" id="step1">
                <div class="form-group">
                    <label for="{{ form.instituicao_cnpj.id_for_label }}">CNPJ:</label>
                    {{ form.instituicao_cnpj }}
                    <span id="cnpj-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.instituicao_nome.id_for_label }}">Nome da Instituição:</label>
                    {{ form.instituicao_nome }}
                    <span id="nome-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.instituicao_telefone.id_for_label }}">Telefone:</label>
                    {{ form.instituicao_telefone }}
                    <span id="telefone-error" class="error-message"></span>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-next" onclick="nextStep(1)">Próximo</button>
                </div>
            </div>

            <!-- Etapa 2 - Endereço -->
            <div class="form-step d-none" id="step2">
                <div class="form-group">
                    <label for="{{ form.cep.id_for_label }}">CEP:</label>
                    {{ form.cep }}
                    <span id="cep-error" class="error-message"></span>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="{{ form.rua.id_for_label }}">Rua:</label>
                        {{ form.rua }}
                        <span id="rua-error" class="error-message"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.numero.id_for_label }}">Número:</label>
                        {{ form.numero }}
                        <span id="numero-error" class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="{{ form.bairro.id_for_label }}">Bairro:</label>
                        {{ form.bairro }}
                        <span id="bairro-error" class="error-message"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.complemento.id_for_label }}">Complemento:</label>
                        {{ form.complemento }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="{{ form.cidade.id_for_label }}">Cidade:</label>
                        {{ form.cidade }}
                        <span id="cidade-error" class="error-message"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.estado.id_for_label }}">Estado:</label>
                        {{ form.estado }}
                        <span id="estado-error" class="error-message"></span>
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-prev" onclick="prevStep(2)">Anterior</button>
                    <button type="button" class="btn-next" onclick="nextStep(2)">Próximo</button>
                </div>
            </div>

            <!-- Etapa 3 - Coordenador -->
            <div class="form-step d-none" id="step3">
                <div class="form-group">
                    <label for="{{ form.nome_completo.id_for_label }}">Nome Completo:</label>
                    {{ form.nome_completo }}
                    <span id="sobrenome-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.cpf.id_for_label }}">CPF:</label>
                    {{ form.cpf }}
                    <span id="cpf-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}">Email:</label>
                    {{ form.email }}
                    <span id="email-error" class="error-message"></span>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-prev" onclick="prevStep(3)">Anterior</button>
                    <button type="submit" class="btn-submit">Finalizar Cadastro</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Área da Imagem -->
    <div class="image-side">
        <div class="incentive-message">
            <h2>Conecte sua instituição com os melhores talentos!</h2>
            <p>Cadastre-se e ofereça oportunidades de estágio para estudantes qualificados.</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    // Máscaras para os campos
    $(document).ready(function() {
        $('#id_instituicao_telefone').mask('(00) 00000-0000');
        $('#id_cpf').mask('000.000.000-00');
        $('#id_instituicao_cnpj').mask('00.000.000/0000-00');
        $('#id_cep').mask('00000-000');
        
        // Configura o evento de fechar alerta
        $('.close-alert').click(function() {
            $(this).parent().addClass('d-none');
        });
    });

    // Navegação entre etapas
    function nextStep(currentStep) {
        if(validateStep(currentStep)) {
            // Atualiza indicador de progresso
            $('.step').removeClass('active');
            $('#step-indicator-' + (currentStep + 1)).addClass('active');
            
            // Navega para próxima etapa
            $('#step' + currentStep).addClass('d-none');
            $('#step' + (currentStep + 1)).removeClass('d-none');
        }
    }

    function prevStep(currentStep) {
        // Atualiza indicador de progresso
        $('.step').removeClass('active');
        $('#step-indicator-' + (currentStep - 1)).addClass('active');
        
        // Navega para etapa anterior
        $('#step' + currentStep).addClass('d-none');
        $('#step' + (currentStep - 1)).removeClass('d-none');
    }

    // Validação de cada etapa
    function validateStep(step) {
        let isValid = true;
        $('#error-alert').addClass('d-none');
        
        if(step === 1) {
            // Validação do CNPJ
            const cnpj = $('#id_instituicao_cnpj').val().replace(/\D/g, '');
            if(cnpj.length !== 14) {
                showError('#id_instituicao_cnpj', 'CNPJ inválido! Digite 14 números.');
                isValid = false;
            } else {
                clearError('#id_instituicao_cnpj');
            }
            
            // Validação do nome da instituição
            if($('#id_instituicao_nome').val().trim() === '') {
                showError('#id_instituicao_nome', 'O nome da instituição é obrigatório.');
                isValid = false;
            } else {
                clearError('#id_instituicao_nome');
            }
            
            // Validação do telefone
            const telefone = $('#id_instituicao_telefone').val().replace(/\D/g, '');
            if(telefone.length !== 11) {
                showError('#id_instituicao_telefone', 'Telefone inválido! Digite 11 números.');
                isValid = false;
            } else {
                clearError('#id_instituicao_telefone');
            }
        }
        
        if(step === 2) {
            // Validação do CEP
            const cep = $('#id_cep').val().replace(/\D/g, '');
            if(cep.length !== 8) {
                showError('#id_cep', 'CEP inválido! Digite 8 números.');
                isValid = false;
            } else {
                clearError('#id_cep');
            }
            
            // Validação dos demais campos de endereço
            const requiredFields = ['#id_rua', '#id_numero', '#id_bairro', '#id_cidade', '#id_estado'];
            requiredFields.forEach(field => {
                if($(field).val().trim() === '') {
                    const fieldName = $(field).attr('name').replace('_', ' ');
                    showError(field, `O campo ${fieldName} é obrigatório.`);
                    isValid = false;
                } else {
                    clearError(field);
                }
            });
        }
        
        return isValid;
    }

    // Busca de CEP
    $('#id_cep').on('blur', function() {
        const cep = $(this).val().replace(/\D/g, '');
        
        if (cep.length === 8) {
            $.ajax({
                url: "{% url 'buscar_cep' %}",
                method: "GET",
                data: { cep: cep },
                beforeSend: function() {
                    $('#id_rua, #id_bairro, #id_cidade, #id_estado').val('...Buscando...').prop('readonly', true);
                },
                success: function(data) {
                    $('#id_rua').val(data.logradouro).prop('readonly', false);
                    $('#id_bairro').val(data.bairro).prop('readonly', false);
                    $('#id_cidade').val(data.localidade).prop('readonly', false);
                    $('#id_estado').val(data.uf).prop('readonly', false);
                    $('#id_complemento').val(data.complemento);
                    clearError('#id_cep');
                },
                error: function(xhr) {
                    showError('#id_cep', xhr.responseJSON.error || 'CEP não encontrado ou serviço indisponível.');
                    $('#id_rua, #id_bairro, #id_cidade, #id_estado').val('').prop('readonly', false);
                }
            });
        }
    });

    // Validação de CPF e CNPJ
    $('#id_cpf, #id_instituicao_cnpj').on('blur', function() {
        const field = $(this);
        const fieldId = field.attr('id');
        const value = field.val().replace(/\D/g, '');
        const isCpf = fieldId === 'id_cpf';
        
        if ((isCpf && value.length === 11) || (!isCpf && value.length === 14)) {
            const url = isCpf ? "{% url 'validate_cpf' %}" : "{% url 'validate_cnpj' %}";
            const errorElement = isCpf ? $('#cpf-error') : $('#cnpj-error');
            
            $.ajax({
                url: url,
                method: "GET",
                data: isCpf ? { cpf: value } : { cnpj: value },
                success: function(data) {
                    errorElement.text('').css('color', '');
                    field.removeClass('field-error');
                    
                    if(!isCpf && data.name) {
                        $('#id_instituicao_nome').val(data.name);
                        if(data.cep) $('#id_cep').val(data.cep);
                        if(data.numero) $('#id_numero').val(data.numero);
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON.error || (isCpf ? 'CPF inválido.' : 'CNPJ inválido.');
                    errorElement.text(errorMsg).css('color', '#dc3545');
                    field.addClass('field-error');
                }
            });
        }
    });

    // Funções auxiliares
    function showError(element, message) {
        const errorElement = $(element).next('.error-message');
        errorElement.text(message);
        $(element).addClass('field-error');
        
        // Rolagem suave para o erro
        $('html, body').animate({
            scrollTop: $(element).offset().top - 100
        }, 300);
        
        // Mostra alerta geral se for o primeiro erro
        if(isFirstError) {
            $('#error-text').text(message);
            $('#error-alert').removeClass('d-none');
        }
    }

    function clearError(element) {
        $(element).removeClass('field-error');
        $(element).next('.error-message').text('');
    }

    // Limpa erros ao começar a digitar
    $('input').on('input', function() {
        if($(this).hasClass('field-error')) {
            clearError(this);
        }
    });
</script>
{% endblock %}