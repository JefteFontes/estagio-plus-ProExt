{% extends "cadastro/base.html" %}
{% load static %}

{% block content %}
<div class="container-login">
    <!-- Área do Formulário -->
    <div class="login-form">
        <img src="{% static 'img/logo.png' %}" alt="Logo +Estagio" class="logo">

        <div class='text-login'>
            <h1>Cadastro de Instituição</h1>
            <p>Preencha os dados da sua instituição de ensino</p>
        </div>

        <!-- Barra de Progresso -->
        <div class="progress-steps">
            <div class="step active" id="step-indicator-1">
                <div class="step-number">1</div>
                <div class="step-label">Instituição</div>
            </div>
            <div class="step" id="step-indicator-2">
                <div class="step-number">2</div>
                <div class="step-label">Endereço</div>
            </div>
            <div class="step" id="step-indicator-3">
                <div class="step-number">3</div>
                <div class="step-label">Coordenador</div>
            </div>
        </div>

        <div id="error-alert" class="error-message d-none"></div>

        <form method="post" id="cadastroForm">
            {% csrf_token %}
            {{ redirect_field }}

            <!-- Etapa 1 - Dados da Instituição -->
            <div class="form-step" id="step1">
                <div class="form-group">
                    <label for="{{ form.instituicao_cnpj.id_for_label }}">CNPJ:</label>
                    {{ form.instituicao_cnpj }}
                    <span id="cnpj-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.instituicao_nome.id_for_label }}">Nome da Instituição:</label>
                    {{ form.instituicao_nome }}
                </div>

                <div class="form-group">
                    <label for="{{ form.instituicao_telefone.id_for_label }}">Telefone:</label>
                    {{ form.instituicao_telefone }}
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-next" onclick="nextStep(1)">Próximo</button>
                </div>
            </div>

            <!-- Etapa 2 - Endereço -->
            <div class="form-step d-none" id="step2">
                <div class="form-group">
                    <label for="{{ form.cep.id_for_label }}">CEP:</label>
                    {{ form.cep }}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.rua.id_for_label }}">Rua:</label>
                        {{ form.rua }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.numero.id_for_label }}">Número:</label>
                        {{ form.numero }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.bairro.id_for_label }}">Bairro:</label>
                        {{ form.bairro }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.complemento.id_for_label }}">Complemento:</label>
                        {{ form.complemento }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.cidade.id_for_label }}">Cidade:</label>
                        {{ form.cidade }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.estado.id_for_label }}">Estado:</label>
                        {{ form.estado }}
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-prev" onclick="prevStep(2)">Anterior</button>
                    <button type="button" class="btn-next" onclick="nextStep(2)">Próximo</button>
                </div>
            </div>

            <!-- Etapa 3 - Coordenador -->
            <div class="form-step d-none" id="step3">
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.nome_completo.id_for_label }}">Nome Completo:</label>
                        {{ form.nome_completo }}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.cpf.id_for_label }}">CPF:</label>
                    {{ form.cpf }}
                    <span id="cpf-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}">Email:</label>
                    {{ form.email }}
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-prev" onclick="prevStep(3)">Anterior</button>
                    <button type="submit" class="btn-submit">Finalizar Cadastro</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Área da Imagem -->
    <div class="image-side">
        <div class="incentive-message">
            <h2>Conecte sua instituição com os melhores talentos!</h2>
            <p>Cadastre-se e ofereça oportunidades de estágio para estudantes qualificados.</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // Máscaras para os campos
    $(document).ready(function() {
        $('#id_instituicao_telefone').mask('(00) 00000-0000');
        $('#id_cpf').mask('000.000.000-00');
        $('#id_instituicao_cnpj').mask('00.000.000/0000-00');
        $('#id_cep').mask('00000-000');
    });

    // Navegação entre etapas
    function nextStep(currentStep) {
        if(validateStep(currentStep)) {
            // Atualiza indicador de progresso
            $('.step').removeClass('active');
            $('#step-indicator-' + (currentStep + 1)).addClass('active');
            
            // Navega para próxima etapa
            $('#step' + currentStep).addClass('d-none');
            $('#step' + (currentStep + 1)).removeClass('d-none');
        }
    }

    function prevStep(currentStep) {
        // Atualiza indicador de progresso
        $('.step').removeClass('active');
        $('#step-indicator-' + (currentStep - 1)).addClass('active');
        
        // Navega para etapa anterior
        $('#step' + currentStep).addClass('d-none');
        $('#step' + (currentStep - 1)).removeClass('d-none');
    }

    // Validação de cada etapa
    function validateStep(step) {
        let isValid = true;
        $('#error-alert').addClass('d-none');
        
        if(step === 1) {
            const cnpj = $('#id_instituicao_cnpj').val().replace(/\D/g, '');
            if(cnpj.length !== 14) {
                $('#error-alert').text('CNPJ inválido! Digite 14 números.').removeClass('d-none');
                isValid = false;
            }
            
            if($('#id_instituicao_nome').val() === '') {
                $('#error-alert').text('O nome da instituição é obrigatório.').removeClass('d-none');
                isValid = false;
            }
        }
        
        if(step === 2) {
            if($('#id_cep').val() === '') {
                $('#error-alert').text('O CEP é obrigatório.').removeClass('d-none');
                isValid = false;
            }
        }
        
        return isValid;
    }

    // Busca de CEP
    $('#id_cep').on('blur', function() {
        let cep = $(this).val().replace(/\D/g, '');
        
        if (cep.length === 8) {
            $.ajax({
                url: "{% url 'buscar_cep' %}",
                method: "GET",
                data: { cep: cep },
                success: function(data) {
                    $('#id_rua').val(data.logradouro);
                    $('#id_bairro').val(data.bairro);
                    $('#id_cidade').val(data.cidade);
                    $('#id_estado').val(data.estado);
                    $('#id_complemento').val(data.complemento);
                },
                error: function(xhr) {
                    $('#error-alert').text(xhr.responseJSON.error || 'Erro ao buscar o CEP.').removeClass('d-none');
                }
            });
        }
    });

    // Validação de CPF e CNPJ
    $('#id_cpf, #id_instituicao_cnpj').on('blur', function() {
        let cpf = $('#id_cpf').val().replace(/\D/g, '');
        let cnpj = $('#id_instituicao_cnpj').val().replace(/\D/g, '');
        
        if (cpf.length === 11) {
            $.ajax({
                url: "{% url 'validate_cpf' %}",
                method: "GET",
                data: { cpf: cpf },
                success: function() {
                    $('#cpf-error').text('');
                },
                error: function(xhr) {
                    $('#cpf-error').text(xhr.responseJSON.error || 'CPF inválido.').css('color', 'red');
                }
            });
        }
        
        if (cnpj.length === 14) {
            $.ajax({
                url: "{% url 'validate_cnpj' %}",
                method: "GET",
                data: { cnpj: cnpj },
                success: function(data) {
                    $('#cnpj-error').text('');
                    if(data.name) $('#id_instituicao_nome').val(data.name);
                    if(data.cep) $('#id_cep').val(data.cep);
                    if(data.numero) $('#id_numero').val(data.numero);
                },
                error: function(xhr) {
                    $('#cnpj-error').text(xhr.responseJSON.error || 'CNPJ inválido.').css('color', 'red');
                }
            });
        }
    });
</script>
{% endblock %}