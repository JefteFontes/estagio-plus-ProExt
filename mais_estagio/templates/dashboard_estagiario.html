{% extends "dashboard/base.html" %}

{% block content %}
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <strong>{{ message }}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Gerenciamento de Estagiários</h1>
        <form method="GET">
            <div class="search-container">
                <input type="text" name="search" placeholder="Buscar por nome, email ou CPF..." class="search-input"
                value="{{ search_query }}">
                <button type="submit" class="search-button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </div>

    <div class="controls-container">
        <h2 class="section-title"></h2>
        <div class="actions">
            <button id="toggle-filters" class="btn-filter">
                <i class="fas fa-filter"></i> Filtros
            </button>
            <a href="{% url 'cadastrar_estagiario' %}" class="btn-add">
                <i class="fas fa-plus"></i> Cadastrar Novo Estagiário
            </a>
        </div>
    </div>

    <div id="filters-container" class="filters-container" style="display: none;">
        <form method="GET" class="filters-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="search">Nome/Email/CPF</label>
                    <input type="text" name="search" id="search" class="form-control"
                    placeholder="Buscar por nome, email ou CPF" value="{{ search_query }}">
                </div>

                <div class="filter-group">
                    <label for="search-matricula">Matrícula</label>
                    <input type="text" name="search-matricula" id="search-matricula" class="form-control"
                    placeholder="Buscar por matrícula" value="{{ search_matricula }}">
                </div>

                <div class="filter-group">
                    <label for="curso">Curso</label>
                    <select name="curso" id="curso" class="form-select">
                        <option value="">Todos os cursos</option>
                        {% for curso_obj in cursos %}
                            <option value="{{ curso_obj.nome_curso }}" {% if curso_obj.nome_curso == curso_filter %}selected{% endif %}>
                                {{ curso_obj.nome_curso }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn-apply">
                    <i class="fas fa-check"></i> Aplicar Filtros
                </button>
                <button type="button" id="reset-filters" class="btn-reset">
                    <i class="fas fa-times"></i> Limpar Filtros
                </button>
            </div>
        </form>
    </div>

    <div class="stats-container">
        <span class="stats-badge">Total de estagiários: {{ total_estagiarios }}</span> 
    </div>

    <hr>

    <h2 class="section-title-status status-active">Alunos Cadastrados (Acesso Ativo) - {{ alunos_cadastrados|length }}</h2>
    {% if alunos_cadastrados %}
    <div class="cards-container">
        {% for estagiario in alunos_cadastrados %}
        <div class="intern-card">
            <div class="card-header">
                <span class="initials">{{ estagiario.nome|slice:":2"|upper }}</span>
                <h3 class="intern-name">{{ estagiario.nome }}</h3>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Matrícula:</span>
                    <span class="info-value">{{ estagiario.matricula }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Curso:</span>
                    <span class="info-value">{{ estagiario.curso }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">{{ estagiario.email }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status do Usuário:</span>
                    <span class="info-value">{{ estagiario.user|yesno:"Ativo,Não Ativo" }}</span>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'editar_estagiario' estagiario.id %}" class="btn-action edit">
                    <i class="fas fa-edit"></i> Editar
                </a>
                <a href="{% url 'deletar_estagiario' estagiario.id %}" class="btn-action delete">
                    <i class="fas fa-trash"></i> Excluir
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-user-graduate empty-icon"></i>
        <p>Não há alunos com acesso ativo ou que correspondam aos filtros.</p>
    </div>
    {% endif %}

    <hr>

    <h2 class="section-title-status status-pending">Alunos Aguardando Confirmação de Acesso - {{ alunos_aguardando_confirmacao|length }}</h2>
    {% if alunos_aguardando_confirmacao %}
    <div class="cards-container">
        {% for estagiario in alunos_aguardando_confirmacao %}
        <div class="intern-card">
            <div class="card-header">
                <span class="initials">{{ estagiario.nome|slice:":2"|upper }}</span>
                <h3 class="intern-name">{{ estagiario.nome }}</h3>
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Matrícula:</span>
                    <span class="info-value">{{ estagiario.matricula }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Curso:</span>
                    <span class="info-value">{{ estagiario.curso }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">{{ estagiario.email }}</span>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'editar_estagiario' estagiario.id %}" class="btn-action edit">
                    <i class="fas fa-edit"></i> Editar
                </a>
                <a href="{% url 'deletar_estagiario' estagiario.id %}" class="btn-action delete">
                    <i class="fas fa-trash"></i> Excluir
                </a>
                {% if not estagiario.user %}
                <form action="{% url 'ativar_acesso_estagiario' estagiario.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-action activate">
                        <i class="fas fa-check-circle"></i> Ativar Acesso
                    </button>
                </form>
                {% else %}
                <button class="btn-action disabled" disabled>
                    <i class="fas fa-user-check"></i> Acesso Ativado (Aguardando status 'True')
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-clock empty-icon"></i>
        <p>Não há alunos aguardando confirmação de acesso ou que correspondam aos filtros.</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleFiltersBtn = document.getElementById('toggle-filters');
    const filtersContainer = document.getElementById('filters-container');
    const resetFiltersBtn = document.getElementById('reset-filters');

    toggleFiltersBtn.addEventListener('click', function() {
        if (filtersContainer.style.display === 'none') {
            filtersContainer.style.display = 'block';
            toggleFiltersBtn.innerHTML = '<i class="fas fa-filter"></i> Ocultar Filtros';
        } else {
            filtersContainer.style.display = 'none';
            toggleFiltersBtn.innerHTML = '<i class="fas fa-filter"></i> Filtros';
        }
    });

    resetFiltersBtn.addEventListener('click', function() {
        document.querySelectorAll('.filters-form input, .filters-form select').forEach(element => {
            if (element.tagName === 'INPUT') {
                element.value = '';
            } else if (element.tagName === 'SELECT') {
                element.selectedIndex = 0;
            }
        });
        window.location.href = window.location.pathname;
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('search') && urlParams.get('search') !== '' ||
        urlParams.has('search-matricula') && urlParams.get('search-matricula') !== '' ||
        urlParams.has('curso') && urlParams.get('curso') !== '') {
        filtersContainer.style.display = 'block';
        toggleFiltersBtn.innerHTML = '<i class="fas fa-filter"></i> Ocultar Filtros';
    }
});
</script>
{% endblock %}