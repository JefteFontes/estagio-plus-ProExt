{% extends "cadastro/base.html" %}
{% load static %}

{% block content %}
{% if form.errors %}
    <div class="message-container">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>{{ error }}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
{% endif %}

<div class="container-login">
    <!-- Área do Formulário -->
    <div class="login-form">
        <img src="{% static 'img/logo.png' %}" alt="Logo +Estagio" class="logo">

        <div class='text-login'>
            <h1>Cadastro de Instituição</h1>
            <p>Preencha os dados da sua instituição de ensino</p>
        </div>

        <!-- Barra de Progresso -->
        <div class="progress-steps">
            <div class="step active" id="step-indicator-1">
                <div class="step-number">1</div>
                <div class="step-label">Instituição</div>
            </div>
            <div class="step" id="step-indicator-2">
                <div class="step-number">2</div>
                <div class="step-label">Endereço</div>
            </div>
            <div class="step" id="step-indicator-3">
                <div class="step-number">3</div>
                <div class="step-label">Coordenador</div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="cadastroForm" novalidate>
            {% csrf_token %}
            {{ redirect_field }}

            <!-- Etapa 1 - Dados da Instituição -->
            <div class="form-step" id="step1">
                <div class="form-group">
                    <label for="{{ form.instituicao_cnpj.id_for_label }}">CNPJ<span class="required-field">*</span></label>
                    {{ form.instituicao_cnpj }}
                    <span id="cnpj-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.instituicao_nome.id_for_label }}">Nome da Instituição<span class="required-field">*</span></label>
                    {{ form.instituicao_nome }}
                    <span id="nome-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.instituicao_telefone.id_for_label }}">Telefone<span class="required-field">*</span></label>
                    {{ form.instituicao_telefone }}
                    <span id="telefone-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.instituicao_logo.id_for_label }}">Logo da Instituição</label>
                    {{ form.instituicao_logo }}
                    <span id="logo-error" class="error-message"></span>
                </div>

                <div class="form-navigation">
                    <a class="btn-prev" href="{% url 'pre_cadastro' %}">Voltar</a>
                    <button type="button" class="btn-next" onclick="nextStep(1)">Próximo</button>
                </div>
            </div>

            <!-- Etapa 2 - Endereço -->
            <div class="form-step d-none" id="step2">
                <div class="form-group">
                    <label for="{{ form.cep.id_for_label }}">CEP<span class="required-field">*</span></label>
                    {{ form.cep }}
                    <span id="cep-error" class="error-message"></span>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="{{ form.rua.id_for_label }}">Rua<span class="required-field">*</span></label>
                        {{ form.rua }}
                        <span id="rua-error" class="error-message"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.numero.id_for_label }}">Número<span class="required-field">*</span></label>
                        {{ form.numero }}
                        <span id="numero-error" class="error-message"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="{{ form.bairro.id_for_label }}">Bairro<span class="required-field">*</span></label>
                        {{ form.bairro }}
                        <span id="bairro-error" class="error-message"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.complemento.id_for_label }}">Complemento</label>
                        {{ form.complemento }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="{{ form.cidade.id_for_label }}">Cidade<span class="required-field">*</span></label>
                        {{ form.cidade }}
                        <span id="cidade-error" class="error-message"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="{{ form.estado.id_for_label }}">Estado<span class="required-field">*</span></label>
                        {{ form.estado }}
                        <span id="estado-error" class="error-message"></span>
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn-prev" onclick="prevStep(2)">Anterior</button>
                    <button type="button" class="btn-next" onclick="nextStep(2)">Próximo</button>
                </div>
            </div>

            <!-- Etapa 3 - Coordenador -->
            <div class="form-step d-none" id="step3">
                <div class="form-group">
                    <label for="{{ form.nome_completo.id_for_label }}">Nome Completo<span class="required-field">*</span></label>
                    {{ form.nome_completo }}
                    <span id="nome_completo-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.cpf.id_for_label }}">CPF<span class="required-field">*</span></label>
                    {{ form.cpf }}
                    <span id="cpf-error" class="error-message"></span>
                </div>

                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}">Email<span class="required-field">*</span></label>
                    {{ form.email }}
                    <span id="email-error" class="error-message"></span>
                </div>
                <div class="form-navigation">
                    <button type="button" class="btn-prev" onclick="prevStep(3)">Anterior</button>
                    <button type="submit" class="btn-submit">Finalizar Cadastro</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Área da Imagem -->
    <div class="image-side">
        <div class="incentive-message">
            <h2>Centralize, acompanhe e otimize os estágios da sua instituição.</h2>
            <p>Cadastre sua instituição e acompanhe todos os estágios de forma simples e eficiente.</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    // Máscaras para os campos
    $(document).ready(function() {
        $('#id_instituicao_telefone, #id_telefone_coordenador').mask('(00) 00000-0000');
        $('#id_cpf').mask('000.000.000-00');
        $('#id_instituicao_cnpj').mask('00.000.000/0000-00');
        $('#id_cep').mask('00000-000');
        
        // Configura o evento de fechar alerta
        $('.close-alert').click(function() {
            $(this).parent().addClass('d-none');
        });
    });

    // Navegação entre etapas
    function nextStep(currentStep) {
        if(validateStep(currentStep)) {
            // Atualiza indicador de progresso
            $('.step').removeClass('active');
            $('#step-indicator-' + (currentStep + 1)).addClass('active');
            
            // Navega para próxima etapa
            $('#step' + currentStep).addClass('d-none');
            $('#step' + (currentStep + 1)).removeClass('d-none');
        }
    }

    function prevStep(currentStep) {
        // Atualiza indicador de progresso
        $('.step').removeClass('active');
        $('#step-indicator-' + (currentStep - 1)).addClass('active');
        
        // Navega para etapa anterior
        $('#step' + currentStep).addClass('d-none');
        $('#step' + (currentStep - 1)).removeClass('d-none');
    }

    // Validação de cada etapa
    function validateStep(step) {
        let isValid = true;
        $('#error-alert').addClass('d-none');
        
        if(step === 1) {
            // Validação do CNPJ
            const cnpj = $('#id_instituicao_cnpj').val().replace(/\D/g, '');
            if(cnpj.length !== 14) {
                showError('#id_instituicao_cnpj', 'CNPJ inválido! Digite 14 números.');
                isValid = false;
            } else {
                clearError('#id_instituicao_cnpj');
            }
            
            // Validação do nome da instituição
            const nomeInstituicao = $('#id_instituicao_nome').val().trim();
            if(nomeInstituicao === '') {
                showError('#id_instituicao_nome', 'O nome da instituição é obrigatório.');
                isValid = false;
            } else if(nomeInstituicao.length < 5) {
                showError('#id_instituicao_nome', 'O nome deve ter pelo menos 5 caracteres.');
                isValid = false;
            } else {
                clearError('#id_instituicao_nome');
            }
            
            // Validação do telefone
            const telefone = $('#id_instituicao_telefone').val().replace(/\D/g, '');
            if(telefone.length < 10 || telefone.length > 11) {
                showError('#id_instituicao_telefone', 'Telefone inválido! Digite 10 ou 11 números.');
                isValid = false;
            } else {
                clearError('#id_instituicao_telefone');
            }
            
            // Validação do logo (se foi enviado)
            const logoInput = $('#id_instituicao_logo')[0];
            if(logoInput.files.length > 0) {
                const file = logoInput.files[0];
                const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                const maxSize = 2 * 1024 * 1024; // 2MB
                
                if(!validTypes.includes(file.type)) {
                    showError('#id_instituicao_logo', 'Formato de arquivo inválido. Use JPG, PNG ou GIF.');
                    isValid = false;
                } else if(file.size > maxSize) {
                    showError('#id_instituicao_logo', 'O arquivo é muito grande. Tamanho máximo: 2MB.');
                    isValid = false;
                } else {
                    clearError('#id_instituicao_logo');
                }
            }
        }
        
        if(step === 2) {
            // Validação do CEP
            const cep = $('#id_cep').val().replace(/\D/g, '');
            if(cep.length !== 8) {
                showError('#id_cep', 'CEP inválido! Digite 8 números.');
                isValid = false;
            } else {
                clearError('#id_cep');
            }
            
            // Validação dos demais campos de endereço
            const requiredFields = [
                {id: '#id_rua', name: 'Rua', minLength: 3},
                {id: '#id_numero', name: 'Número', minLength: 1},
                {id: '#id_bairro', name: 'Bairro', minLength: 3},
                {id: '#id_cidade', name: 'Cidade', minLength: 3},
                {id: '#id_estado', name: 'Estado', minLength: 2}
            ];
            
            requiredFields.forEach(field => {
                const value = $(field.id).val().trim();
                if(value === '') {
                    showError(field.id, `O campo ${field.name} é obrigatório.`);
                    isValid = false;
                } else if(value.length < field.minLength) {
                    showError(field.id, `O campo ${field.name} deve ter pelo menos ${field.minLength} caracteres.`);
                    isValid = false;
                } else {
                    clearError(field.id);
                }
            });
            
            // Validação específica para estado (UF)
            const estado = $('#id_estado').val().trim();
            if(estado.length !== 2) {
                showError('#id_estado', 'O estado deve ser a sigla com 2 letras (ex: SP).');
                isValid = false;
            }
        }
        
        if(step === 3) {
            // Validação do nome completo
            const nomeCompleto = $('#id_nome_completo').val().trim();
            if(nomeCompleto === '') {
                showError('#id_nome_completo', 'O nome completo é obrigatório.');
                isValid = false;
            } else if(nomeCompleto.split(' ').length < 2) {
                showError('#id_nome_completo', 'Por favor, digite seu nome completo.');
                isValid = false;
            } else {
                clearError('#id_nome_completo');
            }
            
            // Validação do CPF
            const cpf = $('#id_cpf').val().replace(/\D/g, '');
            if(cpf.length !== 11) {
                showError('#id_cpf', 'CPF inválido! Digite 11 números.');
                isValid = false;
            } else {
                clearError('#id_cpf');
            }
            
            // Validação do email
            const email = $('#id_email').val().trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if(email === '') {
                showError('#id_email', 'O email é obrigatório.');
                isValid = false;
            } else if(!emailRegex.test(email)) {
                showError('#id_email', 'Por favor, digite um email válido.');
                isValid = false;
            } else {
                clearError('#id_email');
            }
            
            // Validação do telefone do coordenador
            const telefoneCoordenador = $('#id_telefone_coordenador').val().replace(/\D/g, '');
            if(telefoneCoordenador.length < 10 || telefoneCoordenador.length > 11) {
                showError('#id_telefone_coordenador', 'Telefone inválido! Digite 10 ou 11 números.');
                isValid = false;
            } else {
                clearError('#id_telefone_coordenador');
            }
        }
        
        return isValid;
    }

    // Busca de CEP
    $('#id_cep').on('blur', function() {
        const cep = $(this).val().replace(/\D/g, '');
        
        if (cep.length === 8) {
            $.ajax({
                url: "{% url 'buscar_cep' %}",
                method: "GET",
                data: { cep: cep },
                beforeSend: function() {
                    $('#id_rua, #id_bairro, #id_cidade, #id_estado').val('...Buscando...').prop('readonly', true);
                },
                success: function(data) {
                    $('#id_rua').val(data.logradouro).prop('readonly', false);
                    $('#id_bairro').val(data.bairro).prop('readonly', false);
                    $('#id_cidade').val(data.cidade).prop('readonly', false);
                    $('#id_estado').val(data.estado).prop('readonly', false);
                    $('#id_complemento').val(data.complemento);
                    clearError('#id_cep');
                },
                error: function(xhr) {
                    showError('#id_cep', xhr.responseJSON.error || 'CEP não encontrado ou serviço indisponível.');
                    $('#id_rua, #id_bairro, #id_cidade, #id_estado').val('').prop('readonly', false);
                }
            });
        }
    });

    // Validação de CPF e CNPJ
    $('#id_cpf, #id_instituicao_cnpj').on('blur', function() {
        const field = $(this);
        const fieldId = field.attr('id');
        const value = field.val().replace(/\D/g, '');
        const isCpf = fieldId === 'id_cpf';
        
        if ((isCpf && value.length === 11) || (!isCpf && value.length === 14)) {
            const url = isCpf ? "{% url 'validate_cpf' %}" : "{% url 'validate_cnpj' %}";
            const errorElement = isCpf ? $('#cpf-error') : $('#cnpj-error');
            
            $.ajax({
                url: url,
                method: "GET",
                data: isCpf ? { cpf: value } : { cnpj: value },
                success: function(data) {
                    errorElement.text('').css('color', '');
                    field.removeClass('field-error');
                    
                    if(!isCpf && data.name) {
                        $('#id_instituicao_nome').val(data.name);
                        if(data.telefone) $('#id_instituicao_telefone').val(data.telefone);
                        if(data.cep) $('#id_cep').val(data.cep);
                        if(data.numero) $('#id_numero').val(data.numero);
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON.error || (isCpf ? 'CPF inválido.' : 'CNPJ inválido.');
                    errorElement.text(errorMsg).css('color', '#dc3545');
                    field.addClass('field-error');
                }
            });
        }
    });

    // Funções auxiliares
    function showError(element, message) {
        const errorElement = $(element).next('.error-message');
        errorElement.text(message);
        $(element).addClass('field-error');
        
        // Rolagem suave para o erro
        $('html, body').animate({
            scrollTop: $(element).offset().top - 100
        }, 300);
        
        // Mostra alerta geral
        $('#error-text').text(message);
        $('#error-alert').removeClass('d-none');
    }

    function clearError(element) {
        $(element).removeClass('field-error');
        $(element).next('.error-message').text('');
    }

    // Limpa erros ao começar a digitar
    $('input').on('input', function() {
        if($(this).hasClass('field-error')) {
            clearError(this);
            $('#error-alert').addClass('d-none');
        }
    });
</script>
{% endblock %}