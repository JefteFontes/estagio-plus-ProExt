{% extends "dashboard/base.html" %}

{% block content %}
<div class="cadastro-container-dashboard">
    <h2>Cadastro de Empresa</h2>
    <p class="form-header">Preencha os dados da empresa</p>
    {% if form.errors %}
    <div class="alert alert-danger">
        <ul>
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <form method="post" id="empresaForm" novalidate>
        {% csrf_token %}
        
        <div class="form-section">
            <h3 class="section-title">Dados da Empresa</h3>
            <div class="form-row">
                <div class="form-group compact-group">
                    <label for="{{ form.cnpj.id_for_label }}" class="form-label">CNPJ</label>
                    {{ form.cnpj }}
                    {% if form.cnpj.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.cnpj.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group compact-group">
                    <label for="{{ form.nome.id_for_label }}" class="form-label">Nome Fantasia</label>
                    {{ form.nome }}
                    {% if form.nome.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.nome.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group compact-group">
                    <label for="{{ form.razao_social.id_for_label }}" class="form-label">Razão Social</label>
                    {{ form.razao_social }}
                    {% if form.razao_social.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.razao_social.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group compact-group">
                    <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                    {{ form.email}}
                    {% if form.email.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.email.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group compact-group">
                    <label for="{{ form.convenio.id_for_label }}" class="form-label">Convênio</label>
                    {{ form.convenio }}
                    {% if form.convenio.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.convenio.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="{{ form.atividades.id_for_label }}" class="form-label">Atividades</label>
                {{ form.atividades }}
                {% if form.atividades.errors %}
                    <div class="invalid-feedback">
                        {% for error in form.atividades.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-section">
            <h3 class="section-title">Endereço</h3>
            <div class="form-row">
                <div class="form-group compact-group">
                    <label for="{{ form.cep.id_for_label }}" class="form-label">CEP</label>
                    {{ form.cep }}
                    {% if form.cep.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.cep.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="{{ form.rua.id_for_label }}" class="form-label">Rua</label>
                    {{ form.rua }}
                    {% if form.rua.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.rua.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group compact-group">
                    <label for="{{ form.numero.id_for_label }}" class="form-label">Número</label>
                    {{ form.numero }}
                    {% if form.numero.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.numero.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group compact-group">
                    <label for="{{ form.bairro.id_for_label }}" class="form-label">Bairro</label>
                    {{ form.bairro }}
                    {% if form.bairro.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.bairro.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group compact-group">
                    <label for="{{ form.cidade.id_for_label }}" class="form-label">Cidade</label>
                    {{ form.cidade }}
                    {% if form.cidade.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.cidade.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group compact-group">
                    <label for="{{ form.estado.id_for_label }}" class="form-label">Estado</label>
                    {{ form.estado }}
                    {% if form.estado.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.estado.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group compact-group">
                    <label for="{{ form.complemento.id_for_label }}" class="form-label">Complemento</label>
                    {{ form.complemento }}
                    {% if form.complemento.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.complemento.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-user-signup" id="submitBtn">Salvar</button>
            <a href="{% url 'dashboard_empresa' %}" class="btn-cancel">Cancelar</a>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
$(document).ready(function() {
    // Aplicar máscaras
    $('#id_cnpj').mask('00.000.000/0000-00');
    $('#id_cep').mask('00000-000');
    
    // Validação em tempo real do CNPJ
    $('#id_cnpj').on('blur', function() {
        let cnpj = $(this).val().replace(/\D/g, '');
        
        if (cnpj.length === 14) {
            $.ajax({
                url: "{% url 'validate_cnpj' %}",
                method: "GET",
                data: { cnpj: cnpj },
                success: function(data) {
                    $('#id_nome').val(data.name || '');
                    $('#id_razao_social').val(data.razao_social || '');
                    $('#id_email').val(data.email || '');
                    $('#id_cep').val(data.cep || '').trigger('blur');
                    $('#id_numero').val(data.numero || '');
                    $('#id_atividades').val(data.atividades || '');
                    $('#id_complemento').val(data.complemento || '');
                    $('#id_cnpj').removeClass('is-invalid').addClass('is-valid');
                },
                error: function(xhr) {
                    $('#id_cnpj').addClass('is-invalid');
                    showError($('#id_cnpj'), xhr.responseJSON.error || 'Erro ao validar CNPJ');
                }
            });
        } else if (cnpj.length > 0) {
            $('#id_cnpj').addClass('is-invalid');
            showError($('#id_cnpj'), 'CNPJ deve ter 14 dígitos');
        }
    });
    
    // Busca de CEP
    $('#id_cep').on('blur', function() {
        let cep = $(this).val().replace(/\D/g, '');
        
        if (cep.length === 8) {
            $.ajax({
                url: "{% url 'buscar_cep' %}",
                method: "GET",
                data: { cep: cep },
                success: function(data) {
                    if (data.erro) {
                        $('#id_cep').addClass('is-invalid');
                        showError($('#id_cep'), 'CEP não encontrado');
                    } else {
                        $('#id_rua').val(data.logradouro || '');
                        $('#id_bairro').val(data.bairro || '');
                        $('#id_cidade').val(data.cidade || '');
                        $('#id_estado').val(data.estado || '');
                        $('#id_cep').removeClass('is-invalid').addClass('is-valid');
                    }
                },
                error: function(xhr) {
                    $('#id_cep').addClass('is-invalid');
                    showError($('#id_cep'), xhr.responseJSON.error || 'Erro ao buscar CEP');
                }
            });
        } else if (cep.length > 0) {
            $('#id_cep').addClass('is-invalid');
            showError($('#id_cep'), 'CEP deve ter 8 dígitos');
        }
    });
    
    // Validação do formulário antes de enviar
    $('#empresaForm').on('submit', function(e) {
        let isValid = true;
        
        // Validação do CNPJ
        if ($('#id_cnpj').val().replace(/\D/g, '').length !== 14) {
            $('#id_cnpj').addClass('is-invalid');
            showError($('#id_cnpj'), 'CNPJ inválido');
            isValid = false;
        }
        
        // Validação de campos obrigatórios
        $('[required]').each(function() {
            if (!$(this).val()) {
                $(this).addClass('is-invalid');
                showError($(this), 'Este campo é obrigatório');
                isValid = false;
            }
        });
        
        // Validação de email
        const email = $('#id_email').val();
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            $('#id_email').addClass('is-invalid');
            showError($('#id_email'), 'Email inválido');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            // Rolando até o primeiro erro
            $('html, body').animate({
                scrollTop: $('.is-invalid').first().offset().top - 100
            }, 500);
        } else {
            // Desabilitar o botão para evitar múltiplos cliques
            $('#submitBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');
        }
    });
    
    // Remover mensagens de erro quando o usuário começa a digitar
    $('input, select, textarea').on('input', function() {
        $(this).removeClass('is-invalid');
        $(this).next('.invalid-feedback').remove();
    });
    
    // Função para mostrar erros
    function showError(element, message) {
        element.next('.invalid-feedback').remove();
        element.after('<div class="invalid-feedback">' + message + '</div>');
    }
});
</script>
{% endblock %}
{% block extra_css %}
<style>
    .is-invalid {
        border-color: #dc3545 !important;
    }

    .is-valid {
        border-color: #28a745 !important;
    }

    .invalid-feedback {
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }

    .spinner-border {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}